<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HIBO Cocina - Gestor de Producci√≥n</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="css/sanidad-mejorado.css">
  <link rel="stylesheet" href="css/produccion-mejorado.css">
  <link rel="stylesheet" href="css/dashboard-mejorado.css">
  <link rel="stylesheet" href="css/platos-mejorado.css">
  <link rel="stylesheet" href="css/secciones-mejorado.css">
  <link rel="stylesheet" href="css/ofertas-mejorado.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="header-content">
        <h1>üç≥ HIBO COCINA</h1>
        <p>Sistema de Gesti√≥n Integral de Producci√≥n y Pedidos</p>
      </div>
      
      <!-- Navbar integrado en el header -->
      <nav class="navbar">
        <div class="navbar-left">
          <button class="nav-btn active" data-section="dashboard">
            <i class="fas fa-home"></i> Inicio
          </button>
          
          <!-- B√∫squeda Global -->
          <div class="navbar-search">
            <input type="text" id="globalSearch" class="search-input" placeholder="üîç Buscar...">
          </div>
        </div>

        <div class="navbar-right">
          <!-- Grupo: Gesti√≥n de Datos -->
          <div class="nav-dropdown">
            <button class="nav-btn dropdown-toggle">
              <i class="fas fa-database"></i> Gesti√≥n <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu">
              <button class="dropdown-item" data-section="platos">
                <i class="fas fa-plate-wheat"></i> Platos
              </button>
              <button class="dropdown-item" data-section="ingredientes">
                <i class="fas fa-carrot"></i> Ingredientes
              </button>
              <button class="dropdown-item" data-section="escandallos">
                <i class="fas fa-file-invoice"></i> Escandallos
              </button>
              <hr style="margin: 8px 0; border: none; border-top: 1px solid #e0e0e0;">
              <button class="dropdown-item" onclick="abrirModalImport()">
                <i class="fas fa-upload"></i> Importar desde Excel
              </button>
            </div>
          </div>

          <!-- Grupo: Control de Stock -->
          <div class="nav-dropdown">
            <button class="nav-btn dropdown-toggle">
              <i class="fas fa-boxes"></i> Stock <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu">
              <button class="dropdown-item" data-section="inventario">
                <i class="fas fa-warehouse"></i> Inventario
              </button>
              <button class="dropdown-item" data-section="pedidos">
                <i class="fas fa-shopping-cart"></i> Pedidos
              </button>
            </div>
          </div>

          <!-- Grupo: Producci√≥n y Calidad -->
          <div class="nav-dropdown">
            <button class="nav-btn dropdown-toggle">
              <i class="fas fa-industry"></i> Producci√≥n <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu">
              <button class="dropdown-item" data-section="produccion">
                <i class="fas fa-tasks"></i> Partidas
              </button>
              <button class="dropdown-item" data-section="sanidad">
                <i class="fas fa-shield-alt"></i> Sanidad
              </button>
            </div>
          </div>

          <!-- Grupo: Comercial -->
          <div class="nav-dropdown">
            <button class="nav-btn dropdown-toggle">
              <i class="fas fa-shopping-cart"></i> Comercial <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu">
              <button class="dropdown-item" data-section="ofertas">
                <i class="fas fa-tags"></i> Ofertas
              </button>
            </div>
          </div>

          <!-- Grupo: Configuraci√≥n -->
          <div class="nav-dropdown">
            <button class="nav-btn dropdown-toggle">
              <i class="fas fa-cog"></i> Config <i class="fas fa-chevron-down"></i>
            </button>
            <div class="dropdown-menu">
              <button class="dropdown-item" data-section="alergenos">
                <i class="fas fa-exclamation-triangle"></i> Al√©rgenos
              </button>
            </div>
          </div>

          <button class="nav-btn" data-section="estadisticas">
            <i class="fas fa-chart-bar"></i> Estad√≠sticas
          </button>
        </div>
      </nav>
    </header>

    <main class="main-content">
      <!-- Contenedor donde se cargar√°n los m√≥dulos din√°micamente -->
      <div id="sections-container"></div>

      <!-- Secci√≥n Estad√≠sticas -->
      <section id="estadisticas" class="section" style="display:none;">
        <h2>üìä Estad√≠sticas y An√°lisis</h2>
        <div class="stats-container">
          <div class="card">
            <h3>Distribuci√≥n de Platos por Grupo</h3>
            <div id="statsPlatos"></div>
          </div>
          <div class="card">
            <h3>Estado de Pedidos</h3>
            <div id="statsPedidos"></div>
          </div>
          <div class="card">
            <h3>Costos Promedio por Grupo</h3>
            <div id="statsCostos"></div>
          </div>
        </div>
      </section>

      <!-- Secci√≥n Ofertas -->
      <section id="ofertas" class="section" style="display:none;">
        <div class="section-header">
          <h2>üéØ Ofertas y Eventos</h2>
          <div class="actions">
            <button class="btn" onclick="mostrarModalNuevaOferta()">+ Nueva Oferta</button>
            <button class="btn" onclick="mostrarModalNuevoEvento()">+ Nuevo Evento</button>
          </div>
        </div>

        <!-- TABS DE NAVEGACI√ìN -->
        <div style="border-bottom: 2px solid #e0e0e0; margin-bottom: 25px; display: flex; gap: 20px;">
          <button class="tab-btn active" onclick="cambiarTabOferta('ofertas-activas')" style="padding: 12px 24px; border: none; background: none; cursor: pointer; border-bottom: 3px solid #4a90e2; font-weight: 600;">
            üí∞ Ofertas Activas
          </button>
          <button class="tab-btn" onclick="cambiarTabOferta('todas-ofertas')" style="padding: 12px 24px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
            üìã Todas las Ofertas
          </button>
          <button class="tab-btn" onclick="cambiarTabOferta('eventos')" style="padding: 12px 24px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent;">
            üéâ Eventos
          </button>
        </div>

        <!-- TAB: OFERTAS ACTIVAS -->
        <div id="ofertas-activas-tab" style="display: block;">
          <div class="filters">
            <input type="text" id="searchOfertasActivas" placeholder="üîç Buscar ofertas..." onkeyup="filtrarOfertasActivas()">
            <button class="btn btn-secondary" onclick="limpiarFiltrosOfertas('activas')">Limpiar</button>
          </div>

          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Nombre</th>
                  <th>Precio Regular</th>
                  <th>Precio Oferta</th>
                  <th>Descuento</th>
                  <th>Vigencia</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="ofertasActivasTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 20px;">Cargando ofertas...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- TAB: TODAS LAS OFERTAS -->
        <div id="todas-ofertas-tab" style="display: none;">
          <div class="filters">
            <input type="text" id="searchTodasOfertas" placeholder="üîç Buscar..." onkeyup="filtrarTodasOfertas()">
            <select id="filterEstadoOferta" onchange="filtrarTodasOfertas()" style="padding: 8px; border-radius: 0; border: 1px solid #ddd;">
              <option value="">Todos los estados</option>
              <option value="activa">Activa</option>
              <option value="proxima">Pr√≥xima</option>
              <option value="expirada">Expirada</option>
            </select>
            <button class="btn btn-secondary" onclick="limpiarFiltrosOfertas('todas')">Limpiar</button>
          </div>

          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th><input type="checkbox" onchange="toggleSeleccionTodos('ofertas', this)"></th>
                  <th>C√≥digo</th>
                  <th>Nombre</th>
                  <th>Tipo</th>
                  <th>Estado</th>
                  <th>Vigencia</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="todasOfertasTableBody">
                <tr>
                  <td colspan="7" style="text-align: center; padding: 20px;">Cargando ofertas...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="action-bar" style="margin-top: 15px;">
            <button class="btn btn-danger" id="btn-eliminar-ofertas" onclick="eliminarSeleccionados('ofertas', 'ofertas')" disabled>
              üóëÔ∏è Eliminar Seleccionadas
            </button>
          </div>
        </div>

        <!-- TAB: EVENTOS -->
        <div id="eventos-tab" style="display: none;">
          <div class="filters">
            <input type="text" id="searchEventos" placeholder="üîç Buscar eventos..." onkeyup="filtrarEventos()">
            <button class="btn btn-secondary" onclick="limpiarFiltrosEventos()">Limpiar</button>
          </div>

          <div class="table-responsive">
            <table class="data-table">
              <thead>
                <tr>
                  <th><input type="checkbox" onchange="toggleSeleccionTodos('eventos', this)"></th>
                  <th>C√≥digo</th>
                  <th>Nombre</th>
                  <th>Tipo</th>
                  <th>Fecha</th>
                  <th>Lugar</th>
                  <th>Personas</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="eventosTableBody">
                <tr>
                  <td colspan="8" style="text-align: center; padding: 20px;">Cargando eventos...</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="action-bar" style="margin-top: 15px;">
            <button class="btn btn-danger" id="btn-eliminar-eventos" onclick="eliminarSeleccionados('eventos', 'eventos')" disabled>
              üóëÔ∏è Eliminar Seleccionados
            </button>
          </div>
        </div>

        <!-- ESTAD√çSTICAS -->
        <div class="stats-cards" style="margin-top: 30px;">
          <div class="stat-card">
            <h3>Ofertas Activas</h3>
            <p class="stat-value" id="totalOfertasActivas">-</p>
          </div>
          <div class="stat-card">
            <h3>Descuento Promedio</h3>
            <p class="stat-value" id="descuentoPromedio">-</p>
          </div>
          <div class="stat-card">
            <h3>Eventos Programados</h3>
            <p class="stat-value" id="totalEventos">-</p>
          </div>
          <div class="stat-card">
            <h3>Pr√≥ximo Evento</h3>
            <p class="stat-value" id="proximoEvento" style="font-size: 14px;">-</p>
          </div>
        </div>
      </section>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
      <div class="footer-content">
        <p>&copy; 2025 Hibo Cocina - Sistema de Gesti√≥n de Cocina</p>
      </div>
    </footer>
  </div>

  <!-- Modal para crear/editar -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2 id="modalTitle">Modal</h2>
      <div id="modalFormContainer">
        <form id="modalForm">
          <div id="modalFields"></div>
        </form>
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="document.getElementById('modalForm').dispatchEvent(new Event('submit', {bubbles: true, cancelable: true}))">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal din√°mico global -->
  <div id="modal-container"></div>

  <!-- FASE 3 (REFACTORIZADO): Scripts en el nuevo orden -->
  
  <!-- 1. Servicios centralizados (deben cargar primero) -->
  <script src="js/services/api.js"></script>
  <script src="js/services/state.js"></script>
  <script src="js/services/utils.js"></script>

  <!-- 2. Componentes UI reutilizables -->
  <script src="js/ui/modals.js"></script>
  <script src="js/ui/notifications.js"></script>
  <script src="js/ui/forms.js"></script>

  <!-- Logger para debugging condicional -->
  <script src="js/services/logger.js"></script>

  <!-- 3. Capa de compatibilidad (puente entre viejo y nuevo) -->
  <script src="js/compatibility-layer.js"></script>

  <!-- 4. M√≥dulos de negocio -->
  <script src="js/modules/platos.js"></script>
  <script src="js/modules/ingredientes.js"></script>
  <script src="js/modules/escandallos.js"></script>
  <script src="js/modules/pedidos.js"></script>
  <script src="js/modules/inventario.js"></script>
  <script src="js/modules/sanidad.js"></script>
  <script src="js/modules/produccion.js"></script>
  <script src="js/modules/alergenos.js"></script>
  <script src="js/modules/ofertas.js"></script>
  <script src="js/modules/navigation.js"></script>

  <!-- 4.5 Servicios de Producci√≥n -->
  <script src="js/services/produccion-service.js"></script>
  <script src="js/ui/produccion-ui.js"></script>
  <script src="js/ui/charts.js"></script>

  <!-- 5. Scripts principales (legado + migrado) -->
  <script src="module-loader.js"></script>
  <script src="modales-dinamicos.js"></script>
  <script src="app.js"></script>
  <script src="js/app-migrated.js"></script>

  <!-- 6. Inicializaci√≥n refactorizada -->
  <script src="js/app-refactored.js"></script>

  <!-- 6.5 Librer√≠as de gr√°ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

  <!-- 7. WebSocket en tiempo real -->
  <script src="https://cdn.socket.io/4.7.0/socket.io.min.js"></script>
  <script src="js/services/websocket.js"></script>

  <!-- 8. Sistema de notificaciones en tiempo real -->
  <script src="js/services/notifications.js"></script>
  <script src="js/ui/notification-panel.js"></script>

  <!-- 9. Inicializaci√≥n de WebSocket y notificaciones -->
  <script>
    // Inicializar WebSocket y NotificationManager cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', function() {
      const token = localStorage.getItem('authToken') || 'guest';
      
      console.log('üîß DOMContentLoaded - Inicializando WebSocket y NotificationManager');
      console.log('  - window.NotificationManager:', typeof window.NotificationManager);
      console.log('  - window.WebSocketClient:', typeof window.WebSocketClient);
      
      try {
        // Crear cliente WebSocket
        window.wsClient = new WebSocketClient(token);
        console.log('‚úÖ WebSocket cliente creado');
      } catch (err) {
        console.error('‚ùå Error creando WebSocket:', err);
      }
      
      try {
        // Crear gestor de notificaciones
        if (typeof window.NotificationManager === 'undefined') {
          console.warn('‚ö†Ô∏è NotificationManager no est√° definido, usando SimpleNotificationManager');
          window.notificationManager = window.simpleNotificationManager;
        } else {
          window.notificationManager = new NotificationManager(window.wsClient);
          console.log('‚úÖ NotificationManager instancia creada');
        }
      } catch (err) {
        console.error('‚ùå Error creando NotificationManager:', err);
        window.notificationManager = window.simpleNotificationManager;
      }
      
      try {
        // Crear panel de notificaciones
        if (typeof window.NotificationPanel === 'undefined') {
          console.warn('‚ö†Ô∏è NotificationPanel no est√° definido');
        } else {
          window.notificationPanel = new NotificationPanel(window.notificationManager);
          console.log('‚úÖ NotificationPanel creado');
        }
      } catch (err) {
        console.error('‚ùå Error creando NotificationPanel:', err);
      }
      
      // Conectar m√≥dulos a WebSocket para actualizaciones en tiempo real
      setTimeout(() => {
        // Esperar a que los m√≥dulos est√©n cargados
        if (window.ingredientesModule) {
          window.ingredientesModule.connectWebSocket(window.wsClient);
        }
        if (window.inventarioModule) {
          window.inventarioModule.connectWebSocket(window.wsClient);
        }
        if (window.pedidosModule) {
          window.pedidosModule.connectWebSocket(window.wsClient);
        }
        if (window.platosModule) {
          window.platosModule.connectWebSocket(window.wsClient);
        }
        
        console.log('‚úÖ M√≥dulos conectados a WebSocket');
      }, 500);
      
      console.log('‚úÖ Sistema de notificaciones inicializado');
      console.log('WebSocketClient disponible en: window.wsClient');
      console.log('NotificationManager disponible en: window.notificationManager');
      console.log('NotificationPanel disponible en: window.notificationPanel');
    });
  </script>

  <!-- Modal de Importaci√≥n de Excel -->
  <div id="importExcelModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div class="modal-content" style="background: white; border-radius: 8px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
      <div class="modal-header" style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; font-size: 18px;">üì§ Importar Datos desde Excel</h2>
        <button class="btn-close" onclick="cerrarModalImport()" style="background: none; border: none; font-size: 24px; cursor: pointer;">√ó</button>
      </div>

      <div class="modal-body" style="padding: 20px;">
        <!-- Zona de Drop -->
        <div class="upload-zone" id="uploadZone" style="
          border: 2px dashed #007bff;
          border-radius: 8px;
          padding: 40px;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
          background-color: #f8f9fa;
        " onmouseenter="this.style.backgroundColor='#e9ecef'" onmouseleave="this.style.backgroundColor='#f8f9fa'">
          <div style="font-size: 40px; margin-bottom: 15px;">üìÅ</div>
          <h4 style="margin: 10px 0;">Arrastra un archivo aqu√≠ o haz clic para seleccionar</h4>
          <p style="color: #6c757d; margin: 10px 0; font-size: 14px;">
            Formatos soportados: .xlsx, .xls, .csv (m√°x 50MB)
          </p>
          
          <!-- Ficheros soportados por tipo -->
          <div style="margin-top: 20px; text-align: left; background: #fff3cd; padding: 15px; border-radius: 4px; font-size: 13px;">
            <strong>üìã Tipos de importaci√≥n:</strong>
            <ul style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
              <li><strong>platos.xlsx</strong> - Importa tabla de platos</li>
              <li><strong>ingredientes.xlsx</strong> - Importa ingredientes y precios</li>
              <li><strong>escandallos.xlsx</strong> - Importa composici√≥n de platos</li>
              <li><strong>oferta_c.xlsx</strong> - Importa ofertas y eventos</li>
            </ul>
          </div>

          <input type="file" id="fileInput" style="display: none;" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event)">
        </div>

        <!-- Indicador de archivo seleccionado -->
        <div id="fileSelected" style="display: none; margin-top: 20px;">
          <div style="background: #e7f3ff; padding: 15px; border-radius: 4px; border-left: 4px solid #0066cc;">
            <strong>Archivo seleccionado:</strong>
            <p id="fileName" style="margin: 5px 0; color: #0066cc; font-weight: 500;"></p>
            <small id="fileSize" style="color: #666;"></small>
          </div>
        </div>

        <!-- Barra de progreso -->
        <div id="progressContainer" style="display: none; margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <span>Importando...</span>
            <span id="progressPercent">0%</span>
          </div>
          <progress id="progressBar" value="0" max="100" style="width: 100%; height: 25px; border-radius: 4px;"></progress>
        </div>

        <!-- √Årea de resultados -->
        <div id="resultsContainer" style="display: none; margin-top: 20px;">
          <div id="resultsContent"></div>
        </div>
      </div>

      <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button class="btn btn-secondary" onclick="cerrarModalImport()" style="padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 4px; cursor: pointer;">Cancelar</button>
        <button class="btn btn-primary" id="btnImportar" onclick="subirArchivo()" style="display: none; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">‚úÖ Importar</button>
      </div>
    </div>
  </div>

  <style>
    #importExcelModal.show {
      display: flex !important;
    }

    .upload-zone:hover {
      border-color: #0056b3;
    }

    .upload-zone.drag-over {
      border-color: #0056b3;
      background-color: #e9ecef;
      box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
    }

    #resultsContent {
      max-height: 400px;
      overflow-y: auto;
    }

    .resultado-item {
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
      border-left: 4px solid;
      font-size: 14px;
    }

    .resultado-success {
      background: #d4edda;
      border-left-color: #28a745;
      color: #155724;
    }

    .resultado-error {
      background: #f8d7da;
      border-left-color: #dc3545;
      color: #721c24;
    }

    .resultado-warning {
      background: #fff3cd;
      border-left-color: #ffc107;
      color: #856404;
    }
  </style>

  <script>
    let archivoSeleccionado = null;

    // Manejo del upload zone
    const uploadZone = document.getElementById('uploadZone');

    uploadZone.addEventListener('click', () => {
      document.getElementById('fileInput').click();
    });

    uploadZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadZone.classList.add('drag-over');
    });

    uploadZone.addEventListener('dragleave', () => {
      uploadZone.classList.remove('drag-over');
    });

    uploadZone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadZone.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        document.getElementById('fileInput').files = files;
        handleFileSelect({ target: { files } });
      }
    });

    function handleFileSelect(event) {
      const files = event.target.files;
      if (files.length === 0) return;

      archivoSeleccionado = files[0];
      
      // Validar tama√±o
      const maxSize = 50 * 1024 * 1024; // 50MB
      if (archivoSeleccionado.size > maxSize) {
        alert('El archivo es demasiado grande. M√°ximo 50MB.');
        return;
      }

      // Mostrar informaci√≥n del archivo
      document.getElementById('fileSelected').style.display = 'block';
      document.getElementById('fileName').textContent = archivoSeleccionado.name;
      document.getElementById('fileSize').textContent = 
        `Tama√±o: ${(archivoSeleccionado.size / 1024 / 1024).toFixed(2)} MB`;
      
      // Mostrar bot√≥n de importaci√≥n
      document.getElementById('btnImportar').style.display = 'inline-block';
    }

    async function subirArchivo() {
      if (!archivoSeleccionado) {
        alert('Por favor selecciona un archivo');
        return;
      }

      const formData = new FormData();
      formData.append('file', archivoSeleccionado);

      // Mostrar barra de progreso
      document.getElementById('progressContainer').style.display = 'block';
      document.getElementById('btnImportar').disabled = true;

      try {
        const xhr = new XMLHttpRequest();

        // Actualizar progreso
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            document.getElementById('progressBar').value = percentComplete;
            document.getElementById('progressPercent').textContent = 
              Math.round(percentComplete) + '%';
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            mostrarResultados(response.resumen);
          } else {
            const error = JSON.parse(xhr.responseText);
            mostrarError(error.error || 'Error desconocido');
          }
          document.getElementById('btnImportar').disabled = false;
        });

        xhr.addEventListener('error', () => {
          mostrarError('Error en la conexi√≥n');
          document.getElementById('btnImportar').disabled = false;
        });

        xhr.open('POST', '/api/importar');
        xhr.send(formData);

      } catch (error) {
        mostrarError(error.message);
        document.getElementById('btnImportar').disabled = false;
      }
    }

    function mostrarResultados(resumen) {
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsContent = document.getElementById('resultsContent');

      let html = `
        <div style="background: #e8f5e9; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; color: #2e7d32;">‚úÖ Importaci√≥n completada</h4>
          <p style="margin: 5px 0; color: #558b2f;"><strong>Archivo:</strong> ${resumen.archivo}</p>
          <p style="margin: 5px 0; color: #558b2f;"><strong>Hora:</strong> ${new Date(resumen.timestamp).toLocaleString('es-ES')}</p>
        </div>

        <div style="background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          <h5 style="margin: 0 0 10px 0;">Resumen de importaci√≥n:</h5>
      `;

      const entidades = ['platos', 'ingredientes', 'escandallos', 'ofertas', 'eventos'];
      let totalImportados = 0;
      let totalErrores = 0;

      entidades.forEach(entidad => {
        const data = resumen[entidad];
        if (data && (data.importados > 0 || data.errores > 0)) {
          totalImportados += data.importados;
          totalErrores += data.errores;

          const label = {
            platos: 'üçΩÔ∏è Platos',
            ingredientes: 'ü•ò Ingredientes',
            escandallos: 'üìä Escandallos',
            ofertas: 'üéÅ Ofertas',
            eventos: 'üéâ Eventos'
          };

          html += `
            <div style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px; border-left: 4px solid #2196F3;">
              <div style="display: flex; justify-content: space-between;">
                <strong>${label[entidad]}</strong>
                <span style="color: #4caf50;">‚úì ${data.importados}</span>
              </div>
              ${data.errores > 0 ? `<small style="color: #f44336;">‚ö†Ô∏è ${data.errores} errores</small>` : ''}
            </div>
          `;
        }
      });

      html += `
          <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #ddd; display: flex; justify-content: space-between;">
            <strong>Total importados:</strong>
            <strong style="color: #4caf50; font-size: 18px;">${totalImportados}</strong>
          </div>
          ${totalErrores > 0 ? `
            <div style="margin-top: 8px; color: #f44336;">
              <strong>‚ö†Ô∏è Errores: ${totalErrores}</strong>
            </div>
          ` : ''}
        </div>
      `;

      resultsContent.innerHTML = html;
      resultsContainer.style.display = 'block';
      document.getElementById('progressContainer').style.display = 'none';
    }

    function mostrarError(mensaje) {
      const resultsContainer = document.getElementById('resultsContainer');
      const resultsContent = document.getElementById('resultsContent');

      resultsContent.innerHTML = `
        <div class="resultado-item resultado-error">
          <strong>‚ùå Error:</strong> ${mensaje}
        </div>
      `;

      resultsContainer.style.display = 'block';
      document.getElementById('progressContainer').style.display = 'none';
    }

    function cerrarModalImport() {
      const modal = document.getElementById('importExcelModal');
      modal.classList.remove('show');
      modal.style.display = 'none';
      
      // Resetear formulario
      document.getElementById('fileInput').value = '';
      document.getElementById('fileSelected').style.display = 'none';
      document.getElementById('resultsContainer').style.display = 'none';
      document.getElementById('progressContainer').style.display = 'none';
      document.getElementById('btnImportar').style.display = 'none';
      archivoSeleccionado = null;
    }

    function abrirModalImport() {
      const modal = document.getElementById('importExcelModal');
      modal.classList.add('show');
      modal.style.display = 'flex';
    }
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <p>&copy; 2026 HIBO COCINA v2.0.0 | Sistema de Gesti√≥n de Producci√≥n</p>
    </div>
  </footer>
</body>
</html>
