
> hibo-cocina@1.0.0 test
> jest --detectOpenHandles __tests__/pedidos.test.js --maxWorkers=1

[GLOBAL SETUP] Eliminada BD de test previa
[GLOBAL SETUP] Esquema aplicado a BD de test
[MIGRATIONS] Ejecutando migraciones para base de datos de pruebas...
[MIGRATIONS] Ã”Â£Ã  001_tablas_base.sql
[MIGRATIONS] Ã”Â£Ã  002_usuarios_y_auth.sql
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  003_actualizar_ingredientes.sql - SQLITE_ERROR: duplicate column name: familia
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  004_actualizar_platos.sql - SQLITE_ERROR: duplicate column name: familia
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  005_alergenos_platos.sql - SQLITE_ERROR: duplicate column name: sesamo
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  006_actualizar_inventario.sql - SQLITE_ERROR: duplicate column name: ingrediente_i
[MIGRATIONS] Ã”Â£Ã  007_actualizar_inventario_ingrediente_id.sql
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  007_agregar_alergenos_faltantes.sql - SQLITE_ERROR: duplicate column name: crustaceos
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  007_agregar_tipo_entidades.sql - SQLITE_ERROR: duplicate column name: tipo_entidad
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  008_agregar_precios_ingredientes.sql - SQLITE_ERROR: duplicate column name: coste_unidad
[MIGRATIONS] Ã”Â£Ã  008_alergenos_personalizados.sql
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  009_alergenos_palabras_clave.sql - SQLITE_ERROR: duplicate column name: palabras_clav
[MIGRATIONS] Ã”Â£Ã  010_alergenos_oficiales.sql
[MIGRATIONS] Ã”Â£Ã  011_corregir_alergenos_mariscos.sql
[MIGRATIONS] Ã”Â£Ã  011_notificaciones.sql
[MIGRATIONS] Ã”Â£Ã  012_excel_campos_basicos.sql
[MIGRATIONS] Ã”Â£Ã  013_excel_raw_data_espejo.sql
[MIGRATIONS] Ã”Â£Ã  014_modulo_produccion.sql
[MIGRATIONS] Ã”Â£Ã  Todas las migraciones completadas
[GLOBAL SETUP] Base de datos de test lista
  console.log
    [TEST SETUP] Redis disabled for testing

      at Object.log (jest.setup.js:43:9)

  console.log
    [TEST SETUP] Using database: C:\hibo-cocina\data\test-hibo-cocina.db

      at Object.log (jest.setup.js:44:9)

  console.log
    [dotenv@17.2.3] injecting env (12) from .env -- tip: Ã”ÃœÃ–Â´Â©Ã…  override existing env vars with { override: true }

      at _log (node_modules/dotenv/lib/main.js:142:11)

21:36:54 [[33mwarn[39m] Redis caching disabled
  console.log
    Ã”Â£Ã  Conectado a la base de datos SQLite

      at Database.log (src/utils/database.js:23:17)

  console.log
    Ã”Â£Ã  Test database initialized

      at log (__tests__/helpers/testHelper.js:127:13)

2026-01-27 21:36:54 [[32MINFO[39M]: Usuario registrado: testuser@test.com
2026-01-27 21:36:54 [[32MINFO[39M]: POST /register
2026-01-27 21:36:54 [[33MWARN[39M]: Validation failed:
2026-01-27 21:36:54 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:36:54 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:36:54 [[33MWARN[39M]: Validation failed:
2026-01-27 21:36:54 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:36:54 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:36:54 [[33MWARN[39M]: Validation failed:
2026-01-27 21:36:54 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:36:54 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:36:54 [[33MWARN[39M]: Validation failed:
2026-01-27 21:36:54 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:36:54 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:36:54 [[32MINFO[39M]: GET /
2026-01-27 21:36:54 [[32MINFO[39M]: GET /
2026-01-27 21:36:54 [[32MINFO[39M]: GET /
2026-01-27 21:36:54 [[32MINFO[39M]: GET /1
2026-01-27 21:36:54 [[32MINFO[39M]: GET /99999
2026-01-27 21:36:59 [[33MWARN[39M]: Not found route:
2026-01-27 21:36:59 [[32MINFO[39M]: POST /api/pedidos/1/items
2026-01-27 21:36:59 [[33MWARN[39M]: Not found route:
2026-01-27 21:36:59 [[32MINFO[39M]: DELETE /api/pedidos/1/items/1
2026-01-27 21:36:59 [[33MWARN[39M]: Not found route:
2026-01-27 21:36:59 [[32MINFO[39M]: GET /api/pedidos/1/total
2026-01-27 21:37:04 [[32MINFO[39M]: DELETE /1
2026-01-27 21:37:04 [[32MINFO[39M]: DELETE /99999
2026-01-27 21:37:04 [[32MINFO[39M]: GET /
2026-01-27 21:37:04 [[33MWARN[39M]: Validation failed:
2026-01-27 21:37:04 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:37:04 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:37:04 [[33MWARN[39M]: Validation failed:
2026-01-27 21:37:04 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:37:04 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:37:04 [[33MWARN[39M]: Validation failed:
2026-01-27 21:37:04 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:37:04 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:37:04 [[33MWARN[39M]: Validation failed:
2026-01-27 21:37:04 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:37:04 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:37:04 [[32MINFO[39M]: GET /
FAIL __tests__/pedidos.test.js (10.962 s)
  Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos
    POST /api/pedidos - Crear pedido
      Ã”ÃªÃœ Ã”Â£Ã  debe crear pedido vâ”œÃ­lido con lâ”œÂ¡neas (20 ms)
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar sin cliente_nombre (23 ms)
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar sin fecha (18 ms)
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar total negativo (27 ms)
    GET /api/pedidos - Listar pedidos
      Ã”ÃªÃœ Ã”Â£Ã  debe obtener lista de pedidos (9 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe retornar estructura correcta (7 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe soportar filtros bâ”œÃ­sicos (7 ms)
    GET /api/pedidos/:id - Obtener pedido especâ”œÂ¡fico
      Ã”ÃªÃœ Ã”Â£Ã  debe obtener pedido por id (7 ms)
      Ã”ÃªÃœ Ã”Â£Ã  GET a id inexistente maneja bien (10 ms)
    PUT /api/pedidos/:id - Actualizar pedido
      â”œÃ¹ Ã”Â£Ã  endpoint put responde (5005 ms)
    POST /api/pedidos/:id/items - Agregar lâ”œÂ¡nea
      Ã”ÃªÃœ Ã”Â£Ã  endpoint items responde (13 ms)
    DELETE /api/pedidos/:id/items/:item_id - Eliminar lâ”œÂ¡nea
      Ã”ÃªÃœ Ã”Â£Ã  endpoint items delete responde (10 ms)
    GET /api/pedidos/:id/total - Obtener total
      Ã”ÃªÃœ Ã”Â£Ã  endpoint total responde (11 ms)
    Transiciones de Estado
      â”œÃ¹ Ã”Â£Ã  endpoint transiciones responde (5007 ms)
    DELETE /api/pedidos/:id - Eliminar pedido
      Ã”ÃªÃœ Ã”Â£Ã  endpoint delete responde (10 ms)
      Ã”ÃªÃœ Ã”Â£Ã  delete a id inexistente maneja bien (7 ms)
    Validaciones y Seguridad
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar acceso sin token vâ”œÃ­lido (8 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe validar datos requeridos (16 ms)
    Casos Especiales
      Ã”ÃªÃœ Ã”Â£Ã  debe crear pedido sin lâ”œÂ¡neas (vacâ”œÂ¡o) (17 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe manejar cliente con nombre largo (14 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe soportar mâ”œâ•‘ltiples lâ”œÂ¡neas
      Ã”ÃªÃœ Ã”Â£Ã  flujo completo: crear -> listar -> obtener -> actualizar -> delete (25 ms)

  Ã”Ã¹Ã… Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos Ã”Ã‡â•‘ PUT /api/pedidos/:id - Actualizar pedido Ã”Ã‡â•‘ Ã”Â£Ã  endpoint put responde

    Timeout of 5000ms exceeded

      at Test.RequestBase._timeoutError (node_modules/superagent/src/request-base.js:748:17)
      at Timeout._timeoutError (node_modules/superagent/src/request-base.js:764:12)

  Ã”Ã¹Ã… Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos Ã”Ã‡â•‘ Transiciones de Estado Ã”Ã‡â•‘ Ã”Â£Ã  endpoint transiciones responde

    Timeout of 5000ms exceeded

      at Test.RequestBase._timeoutError (node_modules/superagent/src/request-base.js:748:17)
      at Timeout._timeoutError (node_modules/superagent/src/request-base.js:764:12)

Test Suites: 1 failed, 1 total
Tests:       2 failed, 20 passed, 22 total
Snapshots:   0 total
Time:        10.994 s, estimated 12 s
Ran all test suites matching __tests__/pedidos.test.js.
