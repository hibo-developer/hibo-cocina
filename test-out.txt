
> hibo-cocina@1.0.0 test
> jest --detectOpenHandles __tests__/pedidos.test.js

[GLOBAL SETUP] Eliminada BD de test previa
[GLOBAL SETUP] Esquema aplicado a BD de test
[MIGRATIONS] Ejecutando migraciones para base de datos de pruebas...
[MIGRATIONS] Ã”Â£Ã  001_tablas_base.sql
[MIGRATIONS] Ã”Â£Ã  002_usuarios_y_auth.sql
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  003_actualizar_ingredientes.sql - SQLITE_ERROR: duplicate column name: familia
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  004_actualizar_platos.sql - SQLITE_ERROR: duplicate column name: familia
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  005_alergenos_platos.sql - SQLITE_ERROR: duplicate column name: sesamo
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  006_actualizar_inventario.sql - SQLITE_ERROR: duplicate column name: ingrediente_i
[MIGRATIONS] Ã”Â£Ã  007_actualizar_inventario_ingrediente_id.sql
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  007_agregar_alergenos_faltantes.sql - SQLITE_ERROR: duplicate column name: crustaceos
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  007_agregar_tipo_entidades.sql - SQLITE_ERROR: duplicate column name: tipo_entidad
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  008_agregar_precios_ingredientes.sql - SQLITE_ERROR: duplicate column name: coste_unidad
[MIGRATIONS] Ã”Â£Ã  008_alergenos_personalizados.sql
[MIGRATIONS] Ã”ÃœÃ¡Â´Â©Ã…  009_alergenos_palabras_clave.sql - SQLITE_ERROR: duplicate column name: palabras_clav
[MIGRATIONS] Ã”Â£Ã  010_alergenos_oficiales.sql
[MIGRATIONS] Ã”Â£Ã  011_corregir_alergenos_mariscos.sql
[MIGRATIONS] Ã”Â£Ã  011_notificaciones.sql
[MIGRATIONS] Ã”Â£Ã  012_excel_campos_basicos.sql
[MIGRATIONS] Ã”Â£Ã  013_excel_raw_data_espejo.sql
[MIGRATIONS] Ã”Â£Ã  014_modulo_produccion.sql
[MIGRATIONS] Ã”Â£Ã  Todas las migraciones completadas
[GLOBAL SETUP] Base de datos de test lista
  console.log
    [TEST SETUP] Redis disabled for testing

      at Object.log (jest.setup.js:43:9)

  console.log
    [TEST SETUP] Using database: C:\hibo-cocina\data\test-hibo-cocina.db

      at Object.log (jest.setup.js:44:9)

  console.log
    [dotenv@17.2.3] injecting env (12) from .env -- tip: Â­Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

      at _log (node_modules/dotenv/lib/main.js:142:11)

21:29:01 [[33mwarn[39m] Redis caching disabled
  console.log
    Ã”Â£Ã  Conectado a la base de datos SQLite

      at Database.log (src/utils/database.js:23:17)

  console.log
    Ã”Â£Ã  Test database initialized

      at log (__tests__/helpers/testHelper.js:127:13)

2026-01-27 21:29:01 [[32MINFO[39M]: Usuario registrado: testuser@test.com
2026-01-27 21:29:01 [[32MINFO[39M]: POST /register
2026-01-27 21:29:02 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:02 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:02 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:02 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:02 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:02 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:02 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:02 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:02 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:02 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:02 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:02 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:02 [[32MINFO[39M]: GET /
2026-01-27 21:29:02 [[32MINFO[39M]: GET /
2026-01-27 21:29:02 [[32MINFO[39M]: GET /
2026-01-27 21:29:02 [[32MINFO[39M]: GET /1
2026-01-27 21:29:02 [[32MINFO[39M]: GET /99999
2026-01-27 21:29:32 [[33MWARN[39M]: Not found route:
2026-01-27 21:29:32 [[32MINFO[39M]: POST /api/pedidos/1/items
2026-01-27 21:29:32 [[33MWARN[39M]: Not found route:
2026-01-27 21:29:32 [[32MINFO[39M]: DELETE /api/pedidos/1/items/1
2026-01-27 21:29:32 [[33MWARN[39M]: Not found route:
2026-01-27 21:29:32 [[32MINFO[39M]: GET /api/pedidos/1/total
2026-01-27 21:29:52 [[32MINFO[39M]: DELETE /1
2026-01-27 21:29:52 [[32MINFO[39M]: DELETE /99999
2026-01-27 21:29:52 [[32MINFO[39M]: GET /
2026-01-27 21:29:52 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:52 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:52 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:52 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:52 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:52 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:52 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:52 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:52 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:52 [[33MWARN[39M]: Validation failed:
2026-01-27 21:29:52 [[33MWARN[39M]: Validation error: Errores de validaciâ”œâ”‚n en la solicitud
2026-01-27 21:29:52 [[32MINFO[39M]: POST /api/pedidos
2026-01-27 21:29:52 [[32MINFO[39M]: GET /
FAIL __tests__/pedidos.test.js (51.083 s)
  Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos
    POST /api/pedidos - Crear pedido
      Ã”ÃªÃœ Ã”Â£Ã  debe crear pedido vâ”œÃ­lido con lâ”œÂ¡neas (19 ms)
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar sin cliente_nombre (23 ms)
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar sin fecha (19 ms)
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar total negativo (26 ms)
    GET /api/pedidos - Listar pedidos
      Ã”ÃªÃœ Ã”Â£Ã  debe obtener lista de pedidos (9 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe retornar estructura correcta (6 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe soportar filtros bâ”œÃ­sicos (6 ms)
    GET /api/pedidos/:id - Obtener pedido especâ”œÂ¡fico
      Ã”ÃªÃœ Ã”Â£Ã  debe obtener pedido por id (7 ms)
      Ã”ÃªÃœ Ã”Â£Ã  GET a id inexistente maneja bien (10 ms)
    PUT /api/pedidos/:id - Actualizar pedido
      â”œÃ¹ Ã”Â£Ã  debe permitir actualizar estado (10009 ms)
      â”œÃ¹ Ã”Â£Ã  debe permitir actualizar notas (10012 ms)
      â”œÃ¹ Ã”Â£Ã  debe permitir actualizar cliente (10001 ms)
    POST /api/pedidos/:id/items - Agregar lâ”œÂ¡nea
      Ã”ÃªÃœ Ã”Â£Ã  debe aceptar agregar lâ”œÂ¡nea de pedido (23 ms)
    DELETE /api/pedidos/:id/items/:item_id - Eliminar lâ”œÂ¡nea
      Ã”ÃªÃœ Ã”Â£Ã  debe aceptar eliminar lâ”œÂ¡nea de pedido (24 ms)
    GET /api/pedidos/:id/total - Obtener total
      Ã”ÃªÃœ Ã”Â£Ã  debe calcular total (14 ms)
    Transiciones de Estado
      â”œÃ¹ Ã”Â£Ã  debe permitir PENDIENTE -> COMPLETADO (10004 ms)
      â”œÃ¹ Ã”Â£Ã  debe permitir PENDIENTE -> CANCELADO (10015 ms)
    DELETE /api/pedidos/:id - Eliminar pedido
      Ã”ÃªÃœ Ã”Â£Ã  endpoint delete responde (16 ms)
      Ã”ÃªÃœ Ã”Â£Ã  delete a id inexistente maneja bien (10 ms)
    Validaciones y Seguridad
      Ã”ÃªÃœ Ã”Ã˜Ã® debe rechazar acceso sin token vâ”œÃ­lido (14 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe validar datos requeridos (22 ms)
    Casos Especiales
      Ã”ÃªÃœ Ã”Â£Ã  debe crear pedido sin lâ”œÂ¡neas (vacâ”œÂ¡o) (34 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe manejar cliente con nombre largo (20 ms)
      Ã”ÃªÃœ Ã”Â£Ã  debe soportar mâ”œâ•‘ltiples lâ”œÂ¡neas (1 ms)
      Ã”ÃªÃœ Ã”Â£Ã  flujo completo: crear -> listar -> obtener -> actualizar -> delete (28 ms)

  Ã”Ã¹Ã… Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos Ã”Ã‡â•‘ PUT /api/pedidos/:id - Actualizar pedido Ã”Ã‡â•‘ Ã”Â£Ã  debe permitir actualizar estado

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      150 |   describe('PUT /api/pedidos/:id - Actualizar pedido', () => {
      151 |
    > 152 |     it('Ã”Â£Ã  debe permitir actualizar estado', async () => {
          |     ^
      153 |       const res = await makeAuthRequest('put', '/api/pedidos/1', token)
      154 |         .send({
      155 |           estado: 'COMPLETADO'

      at it (__tests__/pedidos.test.js:152:5)
      at describe (__tests__/pedidos.test.js:150:3)
      at Object.describe (__tests__/pedidos.test.js:12:1)

  Ã”Ã¹Ã… Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos Ã”Ã‡â•‘ PUT /api/pedidos/:id - Actualizar pedido Ã”Ã‡â•‘ Ã”Â£Ã  debe permitir actualizar notas

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      159 |     });
      160 |
    > 161 |     it('Ã”Â£Ã  debe permitir actualizar notas', async () => {
          |     ^
      162 |       const res = await makeAuthRequest('put', '/api/pedidos/1', token)
      163 |         .send({
      164 |           notas: 'Sin cebolla'

      at it (__tests__/pedidos.test.js:161:5)
      at describe (__tests__/pedidos.test.js:150:3)
      at Object.describe (__tests__/pedidos.test.js:12:1)

  Ã”Ã¹Ã… Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos Ã”Ã‡â•‘ PUT /api/pedidos/:id - Actualizar pedido Ã”Ã‡â•‘ Ã”Â£Ã  debe permitir actualizar cliente

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      168 |     });
      169 |
    > 170 |     it('Ã”Â£Ã  debe permitir actualizar cliente', async () => {
          |     ^
      171 |       const res = await makeAuthRequest('put', '/api/pedidos/1', token)
      172 |         .send({
      173 |           cliente_nombre: 'Cliente Actualizado'

      at it (__tests__/pedidos.test.js:170:5)
      at describe (__tests__/pedidos.test.js:150:3)
      at Object.describe (__tests__/pedidos.test.js:12:1)

  Ã”Ã¹Ã… Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos Ã”Ã‡â•‘ Transiciones de Estado Ã”Ã‡â•‘ Ã”Â£Ã  debe permitir PENDIENTE -> COMPLETADO

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      228 |   describe('Transiciones de Estado', () => {
      229 |
    > 230 |     it('Ã”Â£Ã  debe permitir PENDIENTE -> COMPLETADO', async () => {
          |     ^
      231 |       const res = await makeAuthRequest('put', '/api/pedidos/1', token)
      232 |         .send({ estado: 'COMPLETADO' });
      233 |

      at it (__tests__/pedidos.test.js:230:5)
      at describe (__tests__/pedidos.test.js:228:3)
      at Object.describe (__tests__/pedidos.test.js:12:1)

  Ã”Ã¹Ã… Â­Æ’Ã´Ã¯ Mâ”œâ”‚dulo de Pedidos Ã”Ã‡â•‘ Transiciones de Estado Ã”Ã‡â•‘ Ã”Â£Ã  debe permitir PENDIENTE -> CANCELADO

    thrown: "Exceeded timeout of 10000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

      235 |     });
      236 |
    > 237 |     it('Ã”Â£Ã  debe permitir PENDIENTE -> CANCELADO', async () => {
          |     ^
      238 |       const res = await makeAuthRequest('put', '/api/pedidos/1', token)
      239 |         .send({ estado: 'CANCELADO' });
      240 |

      at it (__tests__/pedidos.test.js:237:5)
      at describe (__tests__/pedidos.test.js:228:3)
      at Object.describe (__tests__/pedidos.test.js:12:1)

Test Suites: 1 failed, 1 total
Tests:       5 failed, 20 passed, 25 total
Snapshots:   0 total
Time:        51.116 s, estimated 52 s
Ran all test suites matching __tests__/pedidos.test.js.

Jest has detected the following 5 open handles potentially keeping Jest from exiting:

  Ã”Ã¹Ã…  TCPSERVERWRAP

      80 |  */
      81 | function makeAuthRequest(method, path, token) {
    > 82 |   const req = request(app)[method](path);
         |                                   ^
      83 |   if (token) {
      84 |     req.set('Authorization', `Bearer ${token}`);
      85 |   }

      at Test.serverAddress (node_modules/supertest/lib/test.js:63:35)
      at new Test (node_modules/supertest/lib/test.js:49:14)
      at Object.obj.<computed> [as put] (node_modules/supertest/index.js:40:18)
      at makeAuthRequest (__tests__/helpers/testHelper.js:82:35)
      at Object.makeAuthRequest (__tests__/pedidos.test.js:153:25)


  Ã”Ã¹Ã…  TCPSERVERWRAP

      80 |  */
      81 | function makeAuthRequest(method, path, token) {
    > 82 |   const req = request(app)[method](path);
         |                                   ^
      83 |   if (token) {
      84 |     req.set('Authorization', `Bearer ${token}`);
      85 |   }

      at Test.serverAddress (node_modules/supertest/lib/test.js:63:35)
      at new Test (node_modules/supertest/lib/test.js:49:14)
      at Object.obj.<computed> [as put] (node_modules/supertest/index.js:40:18)
      at makeAuthRequest (__tests__/helpers/testHelper.js:82:35)
      at Object.makeAuthRequest (__tests__/pedidos.test.js:162:25)


  Ã”Ã¹Ã…  TCPSERVERWRAP

      80 |  */
      81 | function makeAuthRequest(method, path, token) {
    > 82 |   const req = request(app)[method](path);
         |                                   ^
      83 |   if (token) {
      84 |     req.set('Authorization', `Bearer ${token}`);
      85 |   }

      at Test.serverAddress (node_modules/supertest/lib/test.js:63:35)
      at new Test (node_modules/supertest/lib/test.js:49:14)
      at Object.obj.<computed> [as put] (node_modules/supertest/index.js:40:18)
      at makeAuthRequest (__tests__/helpers/testHelper.js:82:35)
      at Object.makeAuthRequest (__tests__/pedidos.test.js:171:25)


  Ã”Ã¹Ã…  TCPSERVERWRAP

      80 |  */
      81 | function makeAuthRequest(method, path, token) {
    > 82 |   const req = request(app)[method](path);
         |                                   ^
      83 |   if (token) {
      84 |     req.set('Authorization', `Bearer ${token}`);
      85 |   }

      at Test.serverAddress (node_modules/supertest/lib/test.js:63:35)
      at new Test (node_modules/supertest/lib/test.js:49:14)
      at Object.obj.<computed> [as put] (node_modules/supertest/index.js:40:18)
      at makeAuthRequest (__tests__/helpers/testHelper.js:82:35)
      at Object.makeAuthRequest (__tests__/pedidos.test.js:231:25)


  Ã”Ã¹Ã…  TCPSERVERWRAP

      80 |  */
      81 | function makeAuthRequest(method, path, token) {
    > 82 |   const req = request(app)[method](path);
         |                                   ^
      83 |   if (token) {
      84 |     req.set('Authorization', `Bearer ${token}`);
      85 |   }

      at Test.serverAddress (node_modules/supertest/lib/test.js:63:35)
      at new Test (node_modules/supertest/lib/test.js:49:14)
      at Object.obj.<computed> [as put] (node_modules/supertest/index.js:40:18)
      at makeAuthRequest (__tests__/helpers/testHelper.js:82:35)
      at Object.makeAuthRequest (__tests__/pedidos.test.js:238:25)

